# üö® Relat√≥rio de Conflitos Potenciais com Supabase

## ‚ö†Ô∏è **CONFLITOS CR√çTICOS IDENTIFICADOS**

### 1. **Inconsist√™ncia de Nomes de Colunas - FK de Usu√°rio**

#### Problema:
- **`userService.ts`** usa `auth_id` (referencia `auth.users.id`)
- **`enderecoService.ts`** usa `user_id` (referencia mesma coisa)
- **SQL antigo** usa `user_id` na tabela `users`

#### Impacto:
```typescript
// userService.ts - CORRETO para Supabase Auth
auth_id: string; // FK para auth.users.id

// enderecoService.ts - INCORRETO
user_id: string; // Deveria ser auth_id ou uuid
```

#### Solu√ß√£o Necess√°ria:
- Padronizar para `auth_id` em todas as tabelas
- Ou criar tabela de mapeamento `users` pr√≥pria

---

### 2. **Estrutura de Tabelas Inexistente**

#### Tabelas Referenciadas no C√≥digo mas N√ÉO no SQL:
- ‚ùå `endereco_usuario` (enderecoService.ts)
- ‚ùå `perfil_usuario` (userService.ts) 
- ‚ùå `pagamentos` (pagamentoService.ts)
- ‚ùå `metodos_pagamento_usuario` (pagamentoService.ts)

#### SQL Atual vs C√≥digo:
```sql
-- SQL ATUAL: Tabela gen√©rica users
CREATE TABLE users (user_id INT PRIMARY KEY, ...)

-- C√ìDIGO ESPERA: Tabelas espec√≠ficas Supabase
CREATE TABLE perfil_usuario (auth_id UUID REFERENCES auth.users(id), ...)
CREATE TABLE endereco_usuario (auth_id UUID REFERENCES auth.users(id), ...)
```

---

### 3. **Tipos de Dados Incompat√≠veis**

#### IDs String vs Integer:
```typescript
// C√≥digo atual - INCONSISTENTE
export interface Produto {
  id: number; // ‚Üê Inteiro
}

export interface EnderecoData {
  user_id: string; // ‚Üê String (UUID)
}

export interface Pagamento {
  id: number;           // ‚Üê Inteiro  
  pedido_id: number;    // ‚Üê Inteiro
}
```

#### Supabase Recomenda:
```typescript
// RECOMENDADO para Supabase
id: string;        // UUID
auth_id: string;   // UUID referenciando auth.users
created_at: string; // ISO timestamp
```

---

### 4. **Campos de Data/Hora Divergentes**

#### Inconsist√™ncia:
```typescript
// pagamentoService.ts
criado_em: string;     // Snake_case
atualizado_em: string; // Snake_case

// Algumas interfaces
created_at?: string;   // Camel_case
updated_at?: string;   // Camel_case
```

---

### 5. **Enums vs Constraints**

#### Problema:
```sql
-- SQL atual usa ENUM MySQL
status ENUM('ativo', 'inativo', 'bloqueado')

-- Supabase PostgreSQL precisa:
CREATE TYPE status_type AS ENUM ('ativo', 'inativo', 'bloqueado');
ALTER TABLE users ADD COLUMN status status_type DEFAULT 'ativo';
```

---

## üîß **A√á√ïES NECESS√ÅRIAS PARA CORRIGIR**

### 1. **Criar Script SQL Completo para Supabase**
```sql
-- Tabelas necess√°rias
CREATE TABLE perfil_usuario (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  auth_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  nome VARCHAR(100) NOT NULL,
  cpf VARCHAR(14) UNIQUE,
  telefone VARCHAR(15),
  data_nascimento DATE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE endereco_usuario (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  auth_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  tipo VARCHAR(20) NOT NULL,
  cep VARCHAR(8) NOT NULL,
  logradouro TEXT NOT NULL,
  numero VARCHAR(10) NOT NULL,
  complemento TEXT,
  bairro VARCHAR(100) NOT NULL,
  cidade VARCHAR(100) NOT NULL,
  estado VARCHAR(2) NOT NULL,
  pais VARCHAR(50) DEFAULT 'Brasil',
  referencia TEXT,
  principal BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE pagamentos (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  pedido_id UUID NOT NULL,
  metodo_pagamento VARCHAR(20) NOT NULL,
  status_pagamento VARCHAR(20) DEFAULT 'PENDENTE',
  valor_pago DECIMAL(10,2) NOT NULL,
  parcelas INTEGER DEFAULT 1,
  valor_parcela DECIMAL(10,2),
  taxa_juros DECIMAL(5,2) DEFAULT 0,
  codigo_transacao VARCHAR(100),
  gateway_pagamento VARCHAR(50),
  dados_pagamento JSONB,
  data_pagamento TIMESTAMP WITH TIME ZONE,
  data_confirmacao TIMESTAMP WITH TIME ZONE,
  stripe_payment_intent_id VARCHAR(100),
  stripe_charge_id VARCHAR(100),
  stripe_customer_id VARCHAR(100),
  webhook_event_id VARCHAR(100),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 2. **Padronizar Interfaces TypeScript**
```typescript
// Padr√£o UUID para todos os IDs
export interface Produto {
  id: string;           // UUID
  categoria_id: string; // UUID
  // ...
}

export interface EnderecoData {
  auth_id: string;      // UUID padronizado
  // ...
}

export interface Pagamento {
  id: string;           // UUID
  pedido_id: string;    // UUID
  // ...
}
```

### 3. **Atualizar Services para UUID**
```typescript
// enderecoService.ts - CORRIGIR
export interface EnderecoData {
  auth_id: string; // Mudar de user_id para auth_id
  // ...
}

// Todas as fun√ß√µes buscar por UUID
async buscarEnderecosPorUsuario(authId: string) {
  // ...
  .eq('auth_id', authId) // Corrigir campo
}
```

### 4. **RLS (Row Level Security) Policies**
```sql
-- Habilitar RLS
ALTER TABLE perfil_usuario ENABLE ROW LEVEL SECURITY;
ALTER TABLE endereco_usuario ENABLE ROW LEVEL SECURITY;
ALTER TABLE pagamentos ENABLE ROW LEVEL SECURITY;

-- Policies de seguran√ßa
CREATE POLICY "Usu√°rios podem ver apenas seus dados" ON perfil_usuario
  FOR SELECT USING (auth.uid() = auth_id);

CREATE POLICY "Usu√°rios podem inserir apenas seus dados" ON perfil_usuario
  FOR INSERT WITH CHECK (auth.uid() = auth_id);

-- Repetir para outras tabelas...
```

---

## üö¶ **PRIORIDADE DE CORRE√á√ÉO**

### üî¥ **ALTA PRIORIDADE (Quebra o Sistema)**
1. Criar tabelas SQL no Supabase
2. Padronizar `user_id` ‚Üí `auth_id`
3. Converter IDs para UUID
4. Implementar RLS policies

### üü° **M√âDIA PRIORIDADE (Funcionalidade)**
1. Padronizar nomes de campos de data
2. Implementar tratamento de erros Supabase
3. Adicionar valida√ß√µes de constraint

### üü¢ **BAIXA PRIORIDADE (Melhoria)**
1. Otimizar queries
2. Adicionar √≠ndices
3. Implementar cache

---

## ‚ö° **IMPACTO ESTIMADO**

- **Endere√ßos**: N√£o funcionar√£o (tabela inexistente)
- **Pagamentos**: Usar√£o mock (Supabase n√£o implementado)
- **Perfil**: Pode funcionar parcialmente
- **Produtos**: Funcionam (mock ativo)
- **Auth**: Funciona (usa Supabase Auth nativo)

## üéØ **RECOMENDA√á√ÉO**

1. **Imediato**: Criar script SQL completo
2. **Curto prazo**: Atualizar interfaces para UUID
3. **M√©dio prazo**: Implementar servi√ßos Supabase reais
4. **Longo prazo**: Otimizar e adicionar recursos avan√ßados